<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Planilha de Produtos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#4f46e5',
              secondary: '#ec4899',
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-gray-100 font-sans">
    <div class="max-w-6xl mx-auto py-8 px-4">
      <header class="mb-6">
        <h1 class="text-3xl font-bold text-primary mb-2">üì¶ Planilha de Produtos</h1>
        <div class="flex gap-4 flex-wrap text-sm text-gray-700">
          <div id="totalProdutos">Total: 0 produtos</div>
          <div id="totalValor">Valor total: R$ 0,00</div>
          <div id="totalLojas">Lojas: 0</div>
          <div id="ultimaAtualizacao">Atualizado: --</div>
        </div>
      </header>

      <!-- Formul√°rio para adicionar ou editar produto -->
      <div class="mb-6">
        <h2 class="text-xl font-semibold mb-2" id="formTitulo">Adicionar Produto Manualmente</h2>
        <form id="chatForm" class="bg-white p-4 rounded-lg shadow-md grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="text" placeholder="Nome do Produto" id="nome" class="p-2 border rounded" required />
          <input type="text" placeholder="Pre√ßo (R$)" id="preco" class="p-2 border rounded" required />
          <input type="text" placeholder="Loja" id="loja" class="p-2 border rounded" required />
          <input type="url" placeholder="URL do Produto" id="url" class="p-2 border rounded" required />
          <input type="url" placeholder="URL da Imagem" id="imagem" class="p-2 border rounded" required />
          <input type="number" placeholder="Quantidade" id="quantidade" class="p-2 border rounded" value="1" min="1" required />
          <button type="submit" class="md:col-span-2 bg-primary text-white py-2 rounded hover:bg-indigo-700 transition-all" id="btnSubmit">Adicionar Produto</button>
          <button type="button" class="md:col-span-2 bg-gray-400 text-white py-2 rounded hover:bg-gray-600 transition-all hidden" id="btnCancelEdit">Cancelar Edi√ß√£o</button>
        </form>
      </div>

      <!-- Adicionar varia√ß√£o manual -->
      <div class="mb-6">
        <h2 class="text-xl font-semibold mb-2">Adicionar Varia√ß√£o de Produto Existente</h2>
        <form id="varForm" class="bg-white p-4 rounded-lg shadow-md grid grid-cols-1 md:grid-cols-3 gap-4">
          <select id="produtoExistente" class="p-2 border rounded md:col-span-1" required>
            <option value="">Selecione um produto</option>
          </select>
          <input type="text" placeholder="Pre√ßo (R$)" id="varPreco" class="p-2 border rounded" required />
          <input type="url" placeholder="URL da Varia√ß√£o" id="varUrl" class="p-2 border rounded" required />
          <button type="submit" class="md:col-span-3 bg-secondary text-white py-2 rounded hover:bg-pink-600 transition-all">Adicionar Varia√ß√£o</button>
        </form>
      </div>

      <!-- Barra de filtros -->
      <div class="mb-4 flex flex-wrap gap-4 items-center">
        <input
          type="text"
          id="filtroBusca"
          placeholder="Buscar por nome ou loja..."
          class="p-2 border rounded w-full md:w-64"
        />
        <select id="filtroLoja" class="p-2 border rounded">
          <option value="">Todas as lojas</option>
        </select>
        <button onclick="exportarTabela()" class="bg-secondary text-white px-4 py-2 rounded hover:bg-pink-600 transition">
          Exportar
        </button>
      </div>

      <!-- Tabela -->
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-lg shadow-md">
          <thead>
            <tr class="bg-gray-200 text-left text-sm uppercase">
              <th class="p-3">Imagem</th>
              <th class="p-3">Produto</th>
              <th class="p-3">Loja</th>
              <th class="p-3">Pre√ßo</th>
              <th class="p-3">Qtd</th>
              <th class="p-3">Total</th>
              <th class="p-3">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tabelaProdutos"></tbody>
        </table>
      </div>
    </div>

    <script>
      let produtos = [];
      let editIndex = null;

      // Atualiza o formul√°rio para adicionar um produto novo
      function resetForm() {
        document.getElementById('formTitulo').textContent = 'Adicionar Produto Manualmente';
        document.getElementById('btnSubmit').textContent = 'Adicionar Produto';
        document.getElementById('btnCancelEdit').classList.add('hidden');
        editIndex = null;
        document.getElementById('chatForm').reset();
        // habilitar todos os campos
        ['nome', 'loja', 'imagem'].forEach(id => document.getElementById(id).disabled = false);
      }

      // Preenche o formul√°rio para edi√ß√£o de produto
      function editarProduto(index) {
        editIndex = index;
        const p = produtos[index];
        document.getElementById('formTitulo').textContent = `Editando: ${p.nome}`;
        document.getElementById('nome').value = p.nome;
        document.getElementById('preco').value = p.preco.toFixed(2);
        document.getElementById('loja').value = p.loja;
        document.getElementById('url').value = p.url;
        document.getElementById('imagem').value = p.imagem;
        document.getElementById('quantidade').value = p.quantidade;
        document.getElementById('btnSubmit').textContent = 'Salvar Altera√ß√µes';
        document.getElementById('btnCancelEdit').classList.remove('hidden');
        // Ao editar, bloqueia edi√ß√£o de nome, loja e imagem (n√£o mudam na edi√ß√£o)
        ['nome', 'loja', 'imagem'].forEach(id => document.getElementById(id).disabled = true);
      }

      // Remove produto por √≠ndice
      function removerProduto(index) {
        if (editIndex !== null && editIndex === index) {
          resetForm();
        }
        produtos.splice(index, 1);
        renderizarTabela();
      }

      // Renderiza a tabela de produtos e atualiza dashboard e filtros
      function renderizarTabela() {
        const corpo = document.getElementById('tabelaProdutos');
        corpo.innerHTML = '';

        const lojas = new Set();
        let total = 0;

        produtos.forEach((produto, index) => {
          const linha = document.createElement('tr');
          linha.className = 'border-t';

          const subtotal = produto.preco * produto.quantidade;
          total += subtotal;
          lojas.add(produto.loja);

          linha.innerHTML = `
            <td class="p-3"><img src="${produto.imagem}" alt="imagem" class="w-16 h-16 object-cover rounded" /></td>
            <td class="p-3 text-sm"><a href="${produto.url}" target="_blank" class="text-blue-600 hover:underline">${produto.nome}</a></td>
            <td class="p-3 text-sm">${produto.loja}</td>
            <td class="p-3 text-sm">R$ ${produto.preco.toFixed(2)}</td>
            <td class="p-3 text-sm">${produto.quantidade}</td>
            <td class="p-3 text-sm">R$ ${subtotal.toFixed(2)}</td>
            <td class="p-3 text-sm flex gap-2">
              <button onclick="editarProduto(${index})" title="Editar" class="text-blue-500 hover:text-blue-700">
                <i data-lucide="edit-2"></i>
              </button>
              <button onclick="removerProduto(${index})" title="Remover" class="text-red-500 hover:text-red-700">
                <i data-lucide="trash"></i>
              </button>
            </td>
          `;

          corpo.appendChild(linha);
        });

        document.getElementById('totalProdutos').textContent = `Total: ${produtos.length} produtos`;
        document.getElementById('totalValor').textContent = `Valor total: R$ ${total.toFixed(2)}`;
        document.getElementById('totalLojas').textContent = `Lojas: ${lojas.size}`;
        document.getElementById('ultimaAtualizacao').textContent = `Atualizado: ${new Date().toLocaleString()}`;

        // Atualiza filtro loja
        const filtroLoja = document.getElementById('filtroLoja');
        const selecionado = filtroLoja.value || '';
        const opcoes = Array.from(lojas)
          .sort()
          .map(loja => `<option value="${loja}" ${loja === selecionado ? 'selected' : ''}>${loja}</option>`);
        filtroLoja.innerHTML = '<option value="">Todas as lojas</option>' + opcoes.join('');

        // Atualiza select de produto existente para varia√ß√£o
        const produtoExistente = document.getElementById('produtoExistente');
        const selecionadoProd = produtoExistente.value || '';
        const optionsProdutos = produtos
          .map((p, i) => `<option value="${i}" ${i == selecionadoProd ? 'selected' : ''}>${p.nome} (${p.loja})</option>`);
        produtoExistente.innerHTML = '<option value="">Selecione um produto</option>' + optionsProdutos.join('');

        lucide.createIcons();

        aplicarFiltros();
      }

      // Aplica os filtros de busca e loja na tabela
      function aplicarFiltros() {
        const termoBusca = document.getElementById('filtroBusca').value.toLowerCase();
        const filtroLoja = document.getElementById('filtroLoja').value;

        const linhas = document.querySelectorAll('#tabelaProdutos tr');
        linhas.forEach((tr, idx) => {
          const p = produtos[idx];
          const matchBusca = p.nome.toLowerCase().includes(termoBusca) || p.loja.toLowerCase().includes(termoBusca);
          const matchLoja = filtroLoja === '' || p.loja === filtroLoja;
          tr.style.display = matchBusca && matchLoja ? '' : 'none';
        });
      }

      // Exporta a p√°gina completa como HTML
      function exportarTabela() {
        const blob = new Blob([document.documentElement.outerHTML], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'planilha.html';
        a.click();
        URL.revokeObjectURL(url);
      }

      // Eventos
      document.getElementById('chatForm').addEventListener('submit', (e) => {
        e.preventDefault();

        const nome = document.getElementById('nome').value.trim();
        const preco = parseFloat(document.getElementById('preco').value.replace(',', '.'));
        const loja = document.getElementById('loja').value.trim();
        const url = document.getElementById('url').value.trim();
        const imagem = document.getElementById('imagem').value.trim();
        const quantidade = parseInt(document.getElementById('quantidade').value);

        if (isNaN(preco) || preco <= 0) {
          alert('Informe um pre√ßo v√°lido.');
          return;
        }
        if (quantidade <= 0) {
          alert('Informe uma quantidade v√°lida.');
          return;
        }

        if (editIndex !== null) {
          // Salvar edi√ß√£o
          produtos[editIndex].preco = preco;
          produtos[editIndex].url = url;
          produtos[editIndex].quantidade = quantidade;
          // nome, loja, imagem n√£o mudam na edi√ß√£o
          resetForm();
        } else {
          // Adicionar novo produto
          produtos.push({ nome, preco, loja, url, imagem, quantidade });
          document.getElementById('chatForm').reset();
        }
        renderizarTabela();
      });

      document.getElementById('btnCancelEdit').addEventListener('click', (e) => {
        e.preventDefault();
        resetForm();
      });

      // Formul√°rio para adicionar varia√ß√£o
      document.getElementById('varForm').addEventListener('submit', (e) => {
        e.preventDefault();

        const idxProduto = document.getElementById('produtoExistente').value;
        const preco = parseFloat(document.getElementById('varPreco').value.replace(',', '.'));
        const url = document.getElementById('varUrl').value.trim();

        if (idxProduto === '') {
          alert('Selecione um produto existente.');
          return;
        }
        if (isNaN(preco) || preco <= 0) {
          alert('Informe um pre√ßo v√°lido.');
          return;
        }
        if (!url) {
          alert('Informe a URL da varia√ß√£o.');
          return;
        }

        const prodOriginal = produtos[idxProduto];
        // Cria varia√ß√£o copiando nome, loja, imagem, mas com pre√ßo, url e quantidade=1 novos
        produtos.push({
          nome: prodOriginal.nome,
          preco,
          loja: prodOriginal.loja,
          url,
          imagem: prodOriginal.imagem,
          quantidade: 1,
        });

        // Limpa formul√°rio
        document.getElementById('varForm').reset();
        renderizarTabela();
      });

      // Filtros
      document.getElementById('filtroBusca').addEventListener('input', aplicarFiltros);
      document.getElementById('filtroLoja').addEventListener('change', aplicarFiltros);

      // Inicializa tabela
      renderizarTabela();

      // -- Espa√ßo para futura integra√ß√£o com plugin Shopee / Mercado Livre --
      window.addEventListener('message', (event) => {
        // Espera receber mensagem com produto do plugin
        // Exemplo:
        // { type: "novoProduto", data: { nome, preco, loja, url, imagem, quantidade } }
        if (event.data && event.data.type === 'novoProduto') {
          const p = event.data.data;
          // Valida√ß√£o simples
          if (p.nome && p.preco && p.loja && p.url && p.imagem && p.quantidade) {
            produtos.push(p);
            renderizarTabela();
            alert(`Produto "${p.nome}" adicionado pelo plugin.`);
          }
        }
      });
    </script>
  </body>
</html>
