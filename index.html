<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planilha de Produtos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen">
  <div class="max-w-5xl mx-auto p-4">
    <header class="mb-6">
      <h1 class="text-3xl font-bold text-center">ðŸ“¦ Planilha de Produtos</h1>
    </header>

    <!-- Dashboard -->
    <section class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
      <div class="bg-white p-4 rounded-2xl shadow text-center">
        <div class="text-gray-500 text-sm">Produtos</div>
        <div id="totalProdutos" class="text-xl font-bold">0</div>
      </div>
      <div class="bg-white p-4 rounded-2xl shadow text-center">
        <div class="text-gray-500 text-sm">Valor Total</div>
        <div id="valorTotal" class="text-xl font-bold">R$ 0,00</div>
      </div>
      <div class="bg-white p-4 rounded-2xl shadow text-center">
        <div class="text-gray-500 text-sm">Lojas</div>
        <div id="totalLojas" class="text-xl font-bold">0</div>
      </div>
      <div class="bg-white p-4 rounded-2xl shadow text-center">
        <div class="text-gray-500 text-sm">Ãšltima AtualizaÃ§Ã£o</div>
        <div id="ultimaAtualizacao" class="text-xl font-bold">-</div>
      </div>
    </section>

    <!-- Chat de Entrada Manual -->
    <section class="bg-white rounded-2xl shadow p-4 mb-6">
      <h2 class="text-xl font-semibold mb-2">ðŸ’¬ Inserir Produto Manualmente</h2>
      <div id="chatLog" class="space-y-2 max-h-64 overflow-y-auto text-sm bg-gray-50 p-2 rounded mb-2"></div>
      <input id="chatInput" type="text" placeholder="Digite aqui..." class="w-full p-2 border rounded focus:outline-none focus:ring" />
      <button id="enviarChat" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Enviar</button>
    </section>

    <!-- Lista de Produtos -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="text-xl font-semibold mb-2">ðŸ§¾ Lista de Produtos</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-left">
          <thead>
            <tr class="bg-gray-200">
              <th class="px-3 py-2">Nome</th>
              <th class="px-3 py-2">Loja</th>
              <th class="px-3 py-2">PreÃ§o</th>
              <th class="px-3 py-2">Qtd</th>
              <th class="px-3 py-2">Total</th>
              <th class="px-3 py-2">Data</th>
            </tr>
          </thead>
          <tbody id="tabelaProdutos"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    const chatLog = document.getElementById('chatLog');
    const chatInput = document.getElementById('chatInput');
    const enviarBtn = document.getElementById('enviarChat');
    const tabela = document.getElementById('tabelaProdutos');

    const dashboard = {
      totalProdutos: document.getElementById('totalProdutos'),
      valorTotal: document.getElementById('valorTotal'),
      totalLojas: document.getElementById('totalLojas'),
      ultimaAtualizacao: document.getElementById('ultimaAtualizacao')
    };

    let estadoChat = 0;
    let entradaAtual = {};
    const produtos = [];

    function atualizarDashboard() {
      dashboard.totalProdutos.textContent = produtos.length;
      dashboard.valorTotal.textContent = 'R$ ' + produtos.reduce((soma, p) => soma + parseFloat(p.total), 0).toFixed(2);
      dashboard.totalLojas.textContent = new Set(produtos.map(p => p.loja)).size;
      dashboard.ultimaAtualizacao.textContent = new Date().toLocaleString();
    }

    function adicionarProduto(produto) {
      produtos.push(produto);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-3 py-1">${produto.nome}</td>
        <td class="px-3 py-1">${produto.loja}</td>
        <td class="px-3 py-1">R$ ${produto.preco}</td>
        <td class="px-3 py-1">${produto.qtd}</td>
        <td class="px-3 py-1">R$ ${produto.total}</td>
        <td class="px-3 py-1">${produto.data}</td>
      `;
      tabela.appendChild(tr);
      atualizarDashboard();
    }

    function adicionarChat(texto, tipo = 'user') {
      const msg = document.createElement('div');
      msg.className = tipo === 'user' ? 'text-right text-blue-700' : 'text-left text-gray-800';
      msg.textContent = texto;
      chatLog.appendChild(msg);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function processarChat(input) {
      adicionarChat(input, 'user');
      switch (estadoChat) {
        case 0:
          entradaAtual.nome = input;
          adicionarChat('Qual o preÃ§o do produto?');
          estadoChat++;
          break;
        case 1:
          entradaAtual.preco = parseFloat(input.replace(',', '.'));
          adicionarChat('Qual a loja?');
          estadoChat++;
          break;
        case 2:
          entradaAtual.loja = input;
          adicionarChat('Quantidade?');
          estadoChat++;
          break;
        case 3:
          entradaAtual.qtd = parseInt(input);
          entradaAtual.total = (entradaAtual.preco * entradaAtual.qtd).toFixed(2);
          entradaAtual.data = new Date().toLocaleDateString();
          adicionarProduto(entradaAtual);
          adicionarChat('Produto adicionado com sucesso! Digite o nome do prÃ³ximo produto ou deixe em branco.');
          entradaAtual = {};
          estadoChat = 0;
          break;
      }
    }

    enviarBtn.addEventListener('click', () => {
      const valor = chatInput.value.trim();
      if (valor !== '') {
        processarChat(valor);
        chatInput.value = '';
      }
    });

    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') enviarBtn.click();
    });

    // Escutando mensagens do plugin externo (Tampermonkey)
    window.addEventListener('message', (event) => {
      if (event.origin !== 'https://devixippex.github.io') return;
      const produto = event.data;
      if (produto.nome && produto.preco && produto.loja) {
        produto.qtd = 1;
        produto.total = produto.preco;
        produto.data = new Date().toLocaleDateString();
        adicionarProduto(produto);
        alert('Produto enviado via plugin adicionado!');
      }
    });
  </script>
</body>
</html>
