<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planilha de Produtos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .truncate {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold mb-6">Planilha de Produtos</h1>

    <div class="bg-white rounded-xl shadow p-4 mb-6">
      <canvas id="chartMenorPreco" height="100"></canvas>
    </div>

    <!-- filtros e botões omitidos para foco -->

    <table class="min-w-full bg-white rounded-xl shadow overflow-hidden">
      <thead>
        <tr class="bg-gray-200">
          <th class="px-3 py-2 text-left">ID</th>
          <th class="px-3 py-2 text-left">Nome</th>
          <th class="px-3 py-2 text-left">Preço</th>
          <th class="px-3 py-2 text-left">Qtd</th>
          <th class="px-3 py-2 text-left">Loja</th>
          <th class="px-3 py-2 text-left">Imagem</th>
          <th class="px-3 py-2 text-left">URL</th>
          <th class="px-3 py-2 text-left">Ações</th>
        </tr>
      </thead>
      <tbody id="tabela-produtos"></tbody>
    </table>
  </div>

  <script>
    let produtos = [];
    let produtoSelecionadoId = null;
    const tbody = document.getElementById('tabela-produtos');

    function carregarProdutos() {
      const dados = localStorage.getItem('produtos');
      produtos = dados ? JSON.parse(dados) : [];
    }

    function salvarProdutos() {
      localStorage.setItem('produtos', JSON.stringify(produtos));
    }

    function renderizarTabela() {
      tbody.innerHTML = '';
      produtos.forEach(p => {
        const tr = document.createElement('tr');
        tr.className = 'border-b hover:bg-gray-50';

        const isVariacao = p.parentId !== undefined && p.parentId !== null;

        const tdId = document.createElement('td');
        tdId.textContent = p.id;
        tdId.className = 'px-3 py-2 ' + (isVariacao ? 'pl-8 italic text-gray-600' : '');
        tr.appendChild(tdId);

        const tdNome = document.createElement('td');
        tdNome.textContent = isVariacao ? '↳ ' + p.nome : p.nome;
        tdNome.className = 'px-3 py-2 ' + (isVariacao ? 'pl-8 italic text-gray-600' : '');
        tr.appendChild(tdNome);

        const tdPreco = document.createElement('td');
        tdPreco.textContent = p.preco.toFixed(2);
        tdPreco.className = 'px-3 py-2';
        tr.appendChild(tdPreco);

        const tdQtd = document.createElement('td');
        tdQtd.textContent = p.quantidade;
        tdQtd.className = 'px-3 py-2';
        tr.appendChild(tdQtd);

        const tdLoja = document.createElement('td');
        tdLoja.textContent = p.loja;
        tdLoja.className = 'px-3 py-2';
        tr.appendChild(tdLoja);

        const tdImg = document.createElement('td');
        const img = document.createElement('img');
        img.src = p.imagem;
        img.alt = p.nome;
        img.className = 'h-10 w-10 object-contain rounded';
        tdImg.appendChild(img);
        tdImg.className = 'px-3 py-2';
        tr.appendChild(tdImg);

        const tdUrl = document.createElement('td');
        const a = document.createElement('a');
        a.href = p.url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = 'Link';
        a.className = 'text-blue-600 hover:underline';
        tdUrl.appendChild(a);
        tdUrl.className = 'px-3 py-2 truncate max-w-xs';
        tr.appendChild(tdUrl);

        const tdAcoes = document.createElement('td');
        tdAcoes.className = 'px-3 py-2 flex gap-2';

        const btnEditar = document.createElement('button');
        btnEditar.title = 'Editar';
        btnEditar.className = 'text-blue-600 hover:text-blue-900';
        btnEditar.innerHTML = '<i data-lucide="edit-2" class="w-5 h-5"></i>';
        tdAcoes.appendChild(btnEditar);

        const btnExcluir = document.createElement('button');
        btnExcluir.title = 'Excluir';
        btnExcluir.className = 'text-red-600 hover:text-red-900';
        btnExcluir.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';
        btnExcluir.onclick = () => {
          if (confirm(`Excluir produto ${p.id}?`)) {
            produtos = produtos.filter(x => x.id !== p.id && x.parentId !== p.id);
            salvarProdutos();
            renderizarTabela();
          }
        };
        tdAcoes.appendChild(btnExcluir);

        tr.appendChild(tdAcoes);
        tbody.appendChild(tr);
      });
      lucide.replace();
      atualizarGrafico();
    }

    let grafico;
    function atualizarGrafico() {
      const dadosPorId = {};
      produtos.forEach(p => {
        const baseId = p.parentId || p.id;
        if (!dadosPorId[baseId] || dadosPorId[baseId] > p.preco) {
          dadosPorId[baseId] = p.preco;
        }
      });

      const ids = Object.keys(dadosPorId);
      const precos = Object.values(dadosPorId);

      const ctx = document.getElementById('chartMenorPreco').getContext('2d');
      if (grafico) grafico.destroy();
      grafico = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ids,
          datasets: [{
            label: 'Menor Preço por Produto (ID)',
            data: precos,
            backgroundColor: '#3b82f6'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: ctx => `R$ ${ctx.raw.toFixed(2).replace('.', ',')}` } }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: v => 'R$ ' + v.toFixed(2).replace('.', ',')
              }
            }
          }
        }
      });
    }

    carregarProdutos();
    renderizarTabela();
  </script>
</body>
</html>
