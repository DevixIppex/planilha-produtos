<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Planilha Produtos</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #f4f7f9;
    color: #333;
  }
  h1 {
    text-align: center;
    margin-bottom: 20px;
  }
  #controls {
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
  }
  #controls label {
    font-weight: bold;
  }
  select, input[type=number], button {
    padding: 6px 10px;
    font-size: 14px;
    border-radius: 4px;
    border: 1px solid #bbb;
  }
  button {
    cursor: pointer;
    background-color: #007bff;
    border: none;
    color: white;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #0056b3;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    box-shadow: 0 0 10px #ddd;
  }
  th, td {
    padding: 10px 8px;
    border: 1px solid #ddd;
    text-align: center;
    vertical-align: middle;
  }
  th {
    background: #007bff;
    color: white;
  }
  td img {
    width: 70px;
    height: auto;
    border-radius: 4px;
  }
  td a {
    color: #007bff;
    text-decoration: none;
  }
  td a:hover {
    text-decoration: underline;
  }
  .right-align {
    text-align: right;
  }
  #totalRow td {
    font-weight: bold;
    background: #f0f0f0;
  }
  /* Botão fixo adicionar manual */
  #btnAddManual {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 9999;
    background-color: #28a745;
    border: none;
    color: white;
    padding: 12px 18px;
    border-radius: 50px;
    font-size: 16px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #btnAddManual:hover {
    background-color: #1e7e34;
  }
</style>
</head>
<body>

<h1>Planilha de Produtos</h1>

<div id="controls">
  <label>
    Filtrar por loja: 
    <select id="filterStore">
      <option value="">Todas</option>
    </select>
  </label>

  <div>
    <button onclick="colarDoClipboard()">Colar do Clipboard</button>
    <button onclick="savePlanilha()">Salvar Planilha</button>
  </div>
</div>

<table id="table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Imagem</th>
      <th>Nome do Produto</th>
      <th>Loja</th>
      <th>URL</th>
      <th>Preço Unitário (R$)</th>
      <th>Quantidade</th>
      <th>Subtotal (R$)</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr id="totalRow">
      <td colspan="7" class="right-align">Total Geral:</td>
      <td id="totalGeral">0.00</td>
      <td></td>
    </tr>
  </tfoot>
</table>

<button id="btnAddManual" title="Adicionar Produto Manualmente" onclick="adicionarManual()">+</button>

<script>
  const table = document.getElementById("table").getElementsByTagName('tbody')[0];
  const filterStore = document.getElementById("filterStore");
  const totalGeral = document.getElementById("totalGeral");

  let produtos = [];

  // Atualiza IDs e tabela completa
  function atualizarTabela() {
    table.innerHTML = "";
    let lojasSet = new Set();
    let idCounter = 1;

    let filtro = filterStore.value;

    let total = 0;

    for(let p of produtos) {
      if (filtro && p.store !== filtro) continue;

      p.id = idCounter++;

      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${p.id}</td>
        <td><img src="${p.image}" alt="${p.name}" /></td>
        <td>${p.name}</td>
        <td>${p.store}</td>
        <td><a href="${p.url}" target="_blank">Link</a></td>
        <td class="right-align">${p.price.toFixed(2)}</td>
        <td><input type="number" min="1" value="${p.quantity || 1}" style="width:60px" onchange="atualizarQuantidade(${p.id}, this.value)" /></td>
        <td class="right-align">${((p.price)*(p.quantity || 1)).toFixed(2)}</td>
        <td><button onclick="removerProduto(${p.id})" style="background-color:#dc3545; border:none; color:white; padding:5px 10px; border-radius:4px; cursor:pointer;">Excluir</button></td>
      `;

      table.appendChild(tr);

      lojasSet.add(p.store);

      total += p.price * (p.quantity || 1);
    }

    atualizarFiltro([...lojasSet]);

    totalGeral.textContent = total.toFixed(2);
  }

  // Atualiza filtro da loja
  function atualizarFiltro(lojas) {
    const atual = filterStore.value;
    filterStore.innerHTML = '<option value="">Todas</option>';
    lojas.forEach(loja => {
      const opt = document.createElement("option");
      opt.value = loja;
      opt.textContent = loja;
      filterStore.appendChild(opt);
    });
    filterStore.value = atual;
  }

  filterStore.addEventListener('change', atualizarTabela);

  // Atualizar quantidade
  function atualizarQuantidade(id, val) {
    const idx = produtos.findIndex(p => p.id === id);
    if (idx !== -1) {
      produtos[idx].quantity = parseInt(val) > 0 ? parseInt(val) : 1;
      atualizarTabela();
    }
  }

  // Remover produto
  function removerProduto(id) {
    produtos = produtos.filter(p => p.id !== id);
    atualizarTabela();
  }

  // Adicionar produto na planilha
  function adicionarProdutoPlanilha(produto) {
    // Verificar se já existe URL igual - se sim, atualiza quantidade + preço
    let idx = produtos.findIndex(p => p.url === produto.url);
    if (idx !== -1) {
      // Atualiza preço e incrementa quantidade 1 (se quiser manter a quantidade do anterior, pode ajustar aqui)
      produtos[idx].price = produto.price;
      produtos[idx].quantity = (produtos[idx].quantity || 1) + 1;
    } else {
      produto.quantity = produto.quantity || 1;
      produtos.push(produto);
    }
    atualizarTabela();
  }

  // Botão adicionar manual - pede ID e pega url e preço atual da página
  function adicionarManual() {
    const idStr = prompt("Digite o número do ID do produto já cadastrado:");
    if (!idStr) return;
    const id = parseInt(idStr);
    if (isNaN(id)) {
      alert("ID inválido");
      return;
    }
    const produtoOriginal = produtos.find(p => p.id === id);
    if (!produtoOriginal) {
      alert("Produto com esse ID não encontrado.");
      return;
    }

    // Pega url e preço da página atual conforme loja
    const url = window.location.href;

    let price = 0;

    if (url.includes("shopee")) {
      // Shopee - preço: pegar o texto do primeiro elemento com classe IZPeQz ou similar
      const el = document.querySelector(".IZPeQz");
      if (el) {
        // Extrai apenas números e vírgulas/dots, substitui vírgula por ponto para parseFloat
        let txt = el.textContent.replace(/[^\d,\.]/g,"").replace(",",".");
        price = parseFloat(txt) || 0;
      }
    } else if (url.includes("mercadolivre")) {
      // Mercado Livre
      const metaPrice = document.querySelector('meta[itemprop="price"]');
      if (metaPrice) {
        price = parseFloat(metaPrice.content) || 0;
      }
    } else {
      alert("Loja não reconhecida para captura automática de preço. Insira manualmente pelo clipboard.");
      return;
    }

    if (price <= 0) {
      alert("Preço não encontrado ou inválido na página.");
      return;
    }

    adicionarProdutoPlanilha({
      name: produtoOriginal.name,
      store: produtoOriginal.store,
      image: produtoOriginal.image,
      url,
      price,
      quantity: 1,
    });
  }

  // Colar do clipboard JSON array
  async function colarDoClipboard() {
    try {
      const texto = await navigator.clipboard.readText();
      const data = JSON.parse(texto);
      if (!Array.isArray(data)) {
        alert("O conteúdo do clipboard não é uma lista válida.");
        return;
      }
      data.forEach(produto => {
        if (produto.name && produto.store && produto.price && produto.url && produto.image) {
          produto.quantity = produto.quantity || 1;
          adicionarProdutoPlanilha(produto);
        }
      });
    } catch (e) {
      alert("Erro ao colar do clipboard: " + e.message);
    }
  }

  // Salvar planilha em arquivo HTML
  function savePlanilha() {
    // Construir HTML completo com o estado atual da tabela e controles
    const htmlContent = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Planilha Produtos - Salva</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #f4f7f9;
    color: #333;
  }
  h1 {
    text-align: center;
    margin-bottom: 20px;
  }
  #controls {
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
  }
  #controls label {
    font-weight: bold;
  }
  select, input[type=number], button {
    padding: 6px 10px;
    font-size: 14px;
    border-radius: 4px;
    border: 1px solid #bbb;
  }
  button {
    cursor: pointer;
    background-color: #007bff;
    border: none;
    color: white;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #0056b3;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    box-shadow: 0 0 10px #ddd;
  }
  th, td {
    padding: 10px 8px;
    border: 1px solid #ddd;
    text-align: center;
    vertical-align: middle;
  }
  th {
    background: #007bff;
    color: white;
  }
  td img {
    width: 70px;
    height: auto;
    border-radius: 4px;
  }
  td a {
    color: #007bff;
    text-decoration: none;
  }
  td a:hover {
    text-decoration: underline;
  }
  .right-align {
    text-align: right;
  }
  #totalRow td {
    font-weight: bold;
    background: #f0f0f0;
  }
</style>
</head>
<body>
<h1>Planilha de Produtos</h1>
<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Imagem</th>
      <th>Nome do Produto</th>
      <th>Loja</th>
      <th>URL</th>
      <th>Preço Unitário (R$)</th>
      <th>Quantidade</th>
      <th>Subtotal (R$)</th>
    </tr>
  </thead>
  <tbody>
    ${produtos.map(p => `
      <tr>
        <td>${p.id}</td>
        <td><img src="${p.image}" alt="${p.name}"></td>
        <td>${p.name}</td>
        <td>${p.store}</td>
        <td><a href="${p.url}" target="_blank">Link</a></td>
        <td class="right-align">${p.price.toFixed(2)}</td>
        <td>${p.quantity || 1}</td>
        <td class="right-align">${(p.price * (p.quantity || 1)).toFixed(2)}</td>
      </tr>
    `).join("")}
  </tbody>
  <tfoot>
    <tr>
      <td colspan="7" class="right-align">Total Geral:</td>
      <td class="right-align">${totalGeral.textContent}</td>
    </tr>
  </tfoot>
</table>
</body>
</html>`;

    const blob = new Blob([htmlContent], {type: 'text/html'});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "planilha_produtos.html";
    a.click();

    URL.revokeObjectURL(url);
  }

  // Inicializar planilha vazia
  atualizarTabela();
</script>

</body>
</html>
